name: Preview by octoDNS

on:
  pull_request:
    paths:
      - 'octodns/staging/**'

jobs:
  preview:
    name: Preview DNS config
    runs-on: ubuntu-20.04
    env:
      GCLOUD_KEY: ${{ secrets.OCTODNS_GCP_KEY }}
    outputs:
      plan: ${{ steps.preview.outputs.plan }}
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-python@v2
        with:
          python-version: '3.10'
      - run: pip install -r requirements.txt
      - run: echo "$GCLOUD_KEY" > google_cloud_credentials_staging.json
      - uses: solvaholic/octodns-sync@main
        id: generate-plan
        with:
          config_path: octodns/staging/config.yaml

  add-pr-comment:
    name: Add `octodns-sync` plan to comment
    needs: [preview]
    runs-on: ubuntu-20.04
    steps:
      - name: Find previous comment, if present
        uses: peter-evans/find-comment@v1.2.0
        id: fc
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: github-actions[bot]
          body-includes: Automatically generated by octodns-sync
      - name: Create or update comment
        id: prcomment
        uses: peter-evans/create-or-update-comment@v1.4.5
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-id: ${{ steps.fc.outputs.comment-id }}
          body: |
            ## OctoDNS Plan for `${{ github.ref }}`
      
            ${{ needs.preview.outputs.plan }}
      
            Automatically generated by octodns-sync
          edit-mode: replace
